<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√Ålbum Rom√°ntico</title>
  <style>
    body {font-family: 'Poppins', sans-serif; background: #f9f7ff; margin: 0; color: #333;}
    header {text-align: center; padding: 20px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05);}
    h1 {color: #7c3aed;}
    .container {max-width: 900px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);}
    .hidden {display:none;}
    .btn {background: #d946ef; color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;}
    .btn:hover {background: #c026d3;}
    input, textarea {width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px;}
    .gallery {display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-top: 20px;}
    .item {border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #fff;}
    .item img, .item video {width: 100%; height: 160px; object-fit: cover;}
  </style>
</head>
<body>
  <header>
    <h1>√Ålbum Rom√°ntico üíï</h1>
    <p>Acceso privado con PIN compartido</p>
  </header>

  <div class="container">
    <div id="pinSection">
      <h2>Introduce tu PIN</h2>
      <input type="password" id="pinInput" placeholder="PIN (4-8 d√≠gitos)">
      <button id="loginBtn" class="btn">Entrar</button>
      <button id="createPinBtn" class="btn" style="background:#7c3aed">Crear PIN</button>
      <p id="pinMsg"></p>
    </div>

    <div id="albumSection" class="hidden">
      <h2>Galer√≠a</h2>
      <input type="text" id="galleryName" placeholder="Nombre de galer√≠a (ej: T√∫ y Yo)">
      <button id="createGallery" class="btn">Crear galer√≠a</button>
      <select id="gallerySelect"></select>
      <textarea id="description" placeholder="Descripci√≥n"></textarea>
      <input type="file" id="fileInput" multiple accept="image/*,video/*">
      <button id="uploadBtn" class="btn">Subir</button>
      <div class="gallery" id="gallery"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAMlpw4MGaa4XqHKG--NZYKIh6yM8-NuqE",
      authDomain: "galeria-5e025.firebaseapp.com",
      projectId: "galeria-5e025",
      storageBucket: "galeria-5e025.appspot.com",
      messagingSenderId: "273503286623",
      appId: "1:273503286623:web:c49f7fba6c9d550ea232ea",
      measurementId: "G-34KZ77TZ8B"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const serverTs = firebase.firestore.FieldValue.serverTimestamp;

    const pinInput = document.getElementById('pinInput');
    const pinMsg = document.getElementById('pinMsg');
    const loginBtn = document.getElementById('loginBtn');
    const createPinBtn = document.getElementById('createPinBtn');
    const pinSection = document.getElementById('pinSection');
    const albumSection = document.getElementById('albumSection');

    let unlocked = false;
    function simpleHash(str){ let h=0; for(let i=0;i<str.length;i++){h=(h<<5)-h+str.charCodeAt(i); h|=0;} return String(h); }

    async function getPinDoc(){ const ref=db.collection('shared').doc('pin'); const snap=await ref.get(); return {ref,snap}; }

    loginBtn.onclick = async ()=>{
      const val=pinInput.value.trim(); if(!val){pinMsg.textContent='Escribe el PIN';return;}
      const {snap}=await getPinDoc(); if(!snap.exists){pinMsg.textContent='No hay PIN creado';return;}
      if(snap.data().pinHash===simpleHash(val)){unlocked=true; pinSection.classList.add('hidden'); albumSection.classList.remove('hidden'); loadGalleries();} else pinMsg.textContent='PIN incorrecto';
    };

    createPinBtn.onclick = async ()=>{
      const val=pinInput.value.trim(); if(!/^[0-9]{4,8}$/.test(val)){pinMsg.textContent='PIN inv√°lido';return;}
      const {ref}=await getPinDoc(); await ref.set({pinHash:simpleHash(val),createdAt:serverTs()});
      pinMsg.textContent='PIN creado'; unlocked=true; pinSection.classList.add('hidden'); albumSection.classList.remove('hidden'); loadGalleries();
    };

    const gallerySelect=document.getElementById('gallerySelect');
    const galleryName=document.getElementById('galleryName');
    const createGallery=document.getElementById('createGallery');
    const uploadBtn=document.getElementById('uploadBtn');
    const fileInput=document.getElementById('fileInput');
    const galleryDiv=document.getElementById('gallery');

    async function loadGalleries(){
      const q=await db.collection('galleries').get();
      gallerySelect.innerHTML='';
      q.forEach(doc=>{const opt=document.createElement('option'); opt.value=doc.id; opt.textContent=doc.data().name; gallerySelect.appendChild(opt);});
    }

    createGallery.onclick = async ()=>{
      const name=galleryName.value.trim(); if(!name) return alert('Escribe un nombre');
      await db.collection('galleries').add({name,createdAt:serverTs()});
      galleryName.value=''; loadGalleries();
    };

    uploadBtn.onclick = async ()=>{
      const galleryId=gallerySelect.value; if(!galleryId) return alert('Selecciona una galer√≠a');
      const files=fileInput.files; if(!files.length) return alert('Selecciona archivos');
      for(const f of files){
        const path=`shared/${galleryId}/${Date.now()}_${f.name}`;
        const ref=storage.ref().child(path);
        const snap=await ref.put(f);
        const url=await snap.ref.getDownloadURL();
        await db.collection('items').add({galleryId,url,name:f.name,type:f.type.startsWith('video')?'video':'image',createdAt:serverTs()});
      }
      fileInput.value=''; loadGalleryItems(galleryId);
    };

    gallerySelect.onchange=()=>loadGalleryItems(gallerySelect.value);

    async function loadGalleryItems(id){
      const q=await db.collection('items').where('galleryId','==',id).orderBy('createdAt','desc').get();
      galleryDiv.innerHTML='';
      q.forEach(doc=>{
        const d=doc.data();
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=d.type==='video'?`<video src="${d.url}" controls></video>`:`<img src="${d.url}">`;
        galleryDiv.appendChild(el);
      });
    }
  </script>
</body>
</html>
